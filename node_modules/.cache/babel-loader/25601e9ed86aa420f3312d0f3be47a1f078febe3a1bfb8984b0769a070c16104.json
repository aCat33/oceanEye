{"ast":null,"code":"// 标记图层辅助函数 - 用于天地图\nexport const renderMarkersForTianditu = (map, T, layer, allItems, highlightedItemId, playbackState, setHighlightedItemId, setSelectedCluster) => {\n  console.log('renderMarkersForTianditu called', {\n    itemsCount: allItems.length,\n    layerLength: layer.length\n  });\n\n  // 清除旧图层\n  layer.forEach(overlay => map.removeOverLay(overlay));\n  layer.length = 0;\n\n  // 简单聚合逻辑（基于经纬度距离）\n  const clusters = [];\n  const processedIds = new Set();\n  for (let i = 0; i < allItems.length; i++) {\n    if (processedIds.has(allItems[i].id)) continue;\n    const base = allItems[i];\n    const cluster = [base];\n    processedIds.add(base.id);\n    for (let j = i + 1; j < allItems.length; j++) {\n      if (processedIds.has(allItems[j].id)) continue;\n      const distance = Math.sqrt(Math.pow((base.lat - allItems[j].lat) * 111, 2) + Math.pow((base.lon - allItems[j].lon) * 111 * Math.cos(base.lat * Math.PI / 180), 2));\n      if (distance < 50) {\n        // 50km聚合\n        cluster.push(allItems[j]);\n        processedIds.add(allItems[j].id);\n      }\n    }\n    clusters.push(cluster);\n  }\n  clusters.forEach(clusterItems => {\n    const isCluster = clusterItems.length > 1;\n    const mainItem = clusterItems[0];\n    const position = new T.LngLat(mainItem.lon, mainItem.lat);\n    const isHighlighted = !isCluster && mainItem.id === highlightedItemId;\n    const hasAlarmInCluster = clusterItems.some(i => i.isAlarm);\n    if (playbackState.id === mainItem.id && playbackState.playing) return;\n    let iconUrl = '';\n    let iconSize = 32;\n    if (isCluster) {\n      const color = hasAlarmInCluster ? '#dc2626' : clusterItems.some(i => i.type === 'rig') ? '#f97316' : '#2563eb';\n      iconUrl = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\">\n          <circle cx=\"16\" cy=\"16\" r=\"14\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\n          <text x=\"16\" y=\"21\" text-anchor=\"middle\" fill=\"white\" font-size=\"14\" font-weight=\"bold\">${clusterItems.length}</text>\n        </svg>`);\n    } else {\n      const item = mainItem;\n      const rotation = item.course || 0;\n      const color = item.isAlarm ? '#dc2626' : item.type === 'rig' ? '#f97316' : '#3b82f6';\n      if (item.type === 'rig') {\n        iconUrl = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\">\n            <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\n            <path d=\"M16 8l4 4a6 6 0 1 1-8 0z\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"/>\n          </svg>`);\n      } else {\n        iconUrl = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\">\n            <g transform=\"rotate(${rotation} 16 16)\">\n              <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\n              <polygon points=\"16 6 20 20 16 18 12 20\" fill=\"white\"/>\n            </g>\n          </svg>`);\n      }\n      if (item.isAlarm || isHighlighted) {\n        iconSize = 40;\n        const pulseColor = item.isAlarm ? '#ef4444' : '#facc15';\n        iconUrl = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"40\" height=\"40\">\n            <circle cx=\"20\" cy=\"20\" r=\"18\" fill=\"${pulseColor}\" opacity=\"0.3\"/>\n            <circle cx=\"20\" cy=\"20\" r=\"14\" fill=\"${pulseColor}\" opacity=\"0.2\"/>\n            <g transform=\"translate(4, 4)\">\n              ${item.type === 'rig' ? `<circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\n                   <path d=\"M16 8l4 4a6 6 0 1 1-8 0z\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"/>` : `<g transform=\"rotate(${rotation} 16 16)\">\n                     <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\n                     <polygon points=\"16 6 20 20 16 18 12 20\" fill=\"white\"/>\n                   </g>`}\n            </g>\n          </svg>`);\n      }\n    }\n    const icon = new T.Icon({\n      iconUrl: iconUrl,\n      iconSize: new T.Point(iconSize, iconSize),\n      iconAnchor: new T.Point(iconSize / 2, iconSize / 2)\n    });\n    const marker = new T.Marker(position, {\n      icon\n    });\n    marker.addEventListener('click', () => {\n      if (!isCluster) setHighlightedItemId(mainItem.id);\n      setSelectedCluster({\n        id: isCluster ? `cluster-${mainItem.id}` : mainItem.id,\n        isCluster,\n        items: clusterItems\n      });\n    });\n    map.addOverLay(marker);\n    layer.push(marker);\n  });\n  console.log('Markers added to map:', layer.length);\n};","map":{"version":3,"names":["renderMarkersForTianditu","map","T","layer","allItems","highlightedItemId","playbackState","setHighlightedItemId","setSelectedCluster","console","log","itemsCount","length","layerLength","forEach","overlay","removeOverLay","clusters","processedIds","Set","i","has","id","base","cluster","add","j","distance","Math","sqrt","pow","lat","lon","cos","PI","push","clusterItems","isCluster","mainItem","position","LngLat","isHighlighted","hasAlarmInCluster","some","isAlarm","playing","iconUrl","iconSize","color","type","encodeURIComponent","item","rotation","course","pulseColor","icon","Icon","Point","iconAnchor","marker","Marker","addEventListener","items","addOverLay"],"sources":["C:/Users/10211/Desktop/AI Files/oceanEye/src/utils/markerUtils.js"],"sourcesContent":["// 标记图层辅助函数 - 用于天地图\r\nexport const renderMarkersForTianditu = (map, T, layer, allItems, highlightedItemId, playbackState, setHighlightedItemId, setSelectedCluster) => {\r\n  console.log('renderMarkersForTianditu called', { itemsCount: allItems.length, layerLength: layer.length });\r\n  \r\n  // 清除旧图层\r\n  layer.forEach(overlay => map.removeOverLay(overlay));\r\n  layer.length = 0;\r\n\r\n  // 简单聚合逻辑（基于经纬度距离）\r\n  const clusters = [];\r\n  const processedIds = new Set();\r\n  \r\n  for (let i = 0; i < allItems.length; i++) {\r\n    if (processedIds.has(allItems[i].id)) continue;\r\n    const base = allItems[i];\r\n    const cluster = [base];\r\n    processedIds.add(base.id);\r\n    \r\n    for (let j = i + 1; j < allItems.length; j++) {\r\n      if (processedIds.has(allItems[j].id)) continue;\r\n      const distance = Math.sqrt(\r\n        Math.pow((base.lat - allItems[j].lat) * 111, 2) + \r\n        Math.pow((base.lon - allItems[j].lon) * 111 * Math.cos(base.lat * Math.PI / 180), 2)\r\n      );\r\n      if (distance < 50) { // 50km聚合\r\n        cluster.push(allItems[j]);\r\n        processedIds.add(allItems[j].id);\r\n      }\r\n    }\r\n    clusters.push(cluster);\r\n  }\r\n\r\n  clusters.forEach(clusterItems => {\r\n    const isCluster = clusterItems.length > 1;\r\n    const mainItem = clusterItems[0];\r\n    const position = new T.LngLat(mainItem.lon, mainItem.lat);\r\n    const isHighlighted = !isCluster && mainItem.id === highlightedItemId;\r\n    const hasAlarmInCluster = clusterItems.some(i => i.isAlarm);\r\n    \r\n    if (playbackState.id === mainItem.id && playbackState.playing) return;\r\n\r\n    let iconUrl = '';\r\n    let iconSize = 32;\r\n\r\n    if (isCluster) {\r\n      const color = hasAlarmInCluster ? '#dc2626' : \r\n        (clusterItems.some(i=>i.type==='rig') ? '#f97316' : '#2563eb');\r\n      iconUrl = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(\r\n        `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\">\r\n          <circle cx=\"16\" cy=\"16\" r=\"14\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\r\n          <text x=\"16\" y=\"21\" text-anchor=\"middle\" fill=\"white\" font-size=\"14\" font-weight=\"bold\">${clusterItems.length}</text>\r\n        </svg>`\r\n      );\r\n    } else {\r\n      const item = mainItem;\r\n      const rotation = item.course || 0;\r\n      const color = item.isAlarm ? '#dc2626' : (item.type === 'rig' ? '#f97316' : '#3b82f6');\r\n      \r\n      if (item.type === 'rig') {\r\n        iconUrl = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(\r\n          `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\">\r\n            <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\r\n            <path d=\"M16 8l4 4a6 6 0 1 1-8 0z\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"/>\r\n          </svg>`\r\n        );\r\n      } else {\r\n        iconUrl = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(\r\n          `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\">\r\n            <g transform=\"rotate(${rotation} 16 16)\">\r\n              <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\r\n              <polygon points=\"16 6 20 20 16 18 12 20\" fill=\"white\"/>\r\n            </g>\r\n          </svg>`\r\n        );\r\n      }\r\n      \r\n      if (item.isAlarm || isHighlighted) {\r\n        iconSize = 40;\r\n        const pulseColor = item.isAlarm ? '#ef4444' : '#facc15';\r\n        iconUrl = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(\r\n          `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"40\" height=\"40\">\r\n            <circle cx=\"20\" cy=\"20\" r=\"18\" fill=\"${pulseColor}\" opacity=\"0.3\"/>\r\n            <circle cx=\"20\" cy=\"20\" r=\"14\" fill=\"${pulseColor}\" opacity=\"0.2\"/>\r\n            <g transform=\"translate(4, 4)\">\r\n              ${item.type === 'rig' \r\n                ? `<circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\r\n                   <path d=\"M16 8l4 4a6 6 0 1 1-8 0z\" fill=\"none\" stroke=\"white\" stroke-width=\"2\"/>`\r\n                : `<g transform=\"rotate(${rotation} 16 16)\">\r\n                     <circle cx=\"16\" cy=\"16\" r=\"12\" fill=\"${color}\" stroke=\"white\" stroke-width=\"2\"/>\r\n                     <polygon points=\"16 6 20 20 16 18 12 20\" fill=\"white\"/>\r\n                   </g>`\r\n              }\r\n            </g>\r\n          </svg>`\r\n        );\r\n      }\r\n    }\r\n\r\n    const icon = new T.Icon({\r\n      iconUrl: iconUrl,\r\n      iconSize: new T.Point(iconSize, iconSize),\r\n      iconAnchor: new T.Point(iconSize/2, iconSize/2)\r\n    });\r\n\r\n    const marker = new T.Marker(position, { icon });\r\n    \r\n    marker.addEventListener('click', () => {\r\n      if (!isCluster) setHighlightedItemId(mainItem.id);\r\n      setSelectedCluster({ \r\n        id: isCluster ? `cluster-${mainItem.id}` : mainItem.id, \r\n        isCluster, \r\n        items: clusterItems \r\n      });\r\n    });\r\n\r\n    map.addOverLay(marker);\r\n    layer.push(marker);\r\n  });\r\n  \r\n  console.log('Markers added to map:', layer.length);\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}